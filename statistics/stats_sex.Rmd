---
title: "R Notebook"
output: html_notebook
---

```{r}
library(tidyverse)
library(jagsUI)
library(here)
library(furrr)
library(bayestestR)
```

male is index 1, female 2

```{r}
sex_results <- readRDS(here("modeling", "results", "lnorm_sex.rds"))
```

Median
```{r}
#male
plan(multisession)

median_draws_male <- future_map2(.x = rstan::extract(sex_results, "mu_alt_male")[[1]], 
            .y = rstan::extract(sex_results, "sigma_alt_male")[[1]],
            .progress = TRUE,
            .options = furrr_options(seed = 8),
            .f = function(x, y){
              res <- rlnorm(n = 10000, 
                          meanlog = x,
                          sdlog = y)
              
              res <- res * 2183.475
              
              return(median(res))
            })

plan(sequential)

median_draws_male %>% 
  unlist() %>% 
  median() #264.8976

median_draws_male %>% 
  unlist() %>% 
  hdi(ci = 0.5) #50% HDI: [232.08, 301.08]

median_draws_male %>% 
  unlist() %>% 
  hdi(ci = 0.95) #95% HDI: [164.78, 363.48]

# female
plan(multisession)

median_draws_female <- future_map2(.x = rstan::extract(sex_results, "mu_alt_female")[[1]], 
            .y = rstan::extract(sex_results, "sigma_alt_female")[[1]],
            .progress = TRUE,
            .options = furrr_options(seed = 8),
            .f = function(x, y){
              res <- rlnorm(n = 10000, 
                          meanlog = x,
                          sdlog = y)
              
              res <- res * 2183.475
              
              return(median(res))
            })

plan(sequential)

median_draws_female %>% 
  unlist() %>% 
  median() #217.119

median_draws_female %>% 
  unlist() %>% 
  hdi(ci = 0.5) #50% HDI: [184.59, 250.86]

median_draws_female %>% 
  unlist() %>% 
  hdi(ci = 0.95) #95% HDI: [125.24, 311.77]
```

Mean
```{r}
#male
plan(multisession)

mean_draws_male <- future_map2(.x = rstan::extract(sex_results, "mu_alt_male")[[1]], 
            .y = rstan::extract(sex_results, "sigma_alt_male")[[1]],
            .progress = TRUE,
            .options = furrr_options(seed = 8),
            .f = function(x, y){
              res <- rlnorm(n = 10000, 
                          meanlog = x,
                          sdlog = y)
              
              res <- res * 2183.475
              
              return(mean(res))
            })

plan(sequential)

mean_draws_male %>% 
  unlist() %>% 
  median() #408.4257

mean_draws_male %>% 
  unlist() %>% 
  hdi(ci = 0.5) #50% HDI: [363.13, 442.74]

mean_draws_male %>% 
  unlist() %>% 
  hdi(ci = 0.95) #95% HDI: [295.97, 542.08]

#female
plan(multisession)

mean_draws_female <- future_map2(.x = rstan::extract(sex_results, "mu_alt_female")[[1]], 
            .y = rstan::extract(sex_results, "sigma_alt_female")[[1]],
            .progress = TRUE,
            .options = furrr_options(seed = 8),
            .f = function(x, y){
              res <- rlnorm(n = 10000, 
                          meanlog = x,
                          sdlog = y)
              
              res <- res * 2183.475
              
              return(mean(res))
            })

plan(sequential)

mean_draws_female %>% 
  unlist() %>% 
  median() #340.746

mean_draws_female %>% 
  unlist() %>% 
  hdi(ci = 0.5) #50% HDI: [296.86, 369.75]

mean_draws_female %>% 
  unlist() %>% 
  hdi(ci = 0.95) #95% HDI: [234.79, 460.79]
```

Are these birds regularly flying lower than the flight heights reported via radar?
Calculate the percentage of these locations that male below the minimum	threshold in Horton et al. 2016 (155m)
```{r}
#male
plan(multisession)

pct_below_radar_threshold_male <- future_map2(.x = rstan::extract(sex_results, "mu_alt_male")[[1]], 
            .y = rstan::extract(sex_results, "sigma_alt_male")[[1]],
            .progress = TRUE,
            .options = furrr_options(seed = 8),
            .f = function(x, y){
              res <- rlnorm(n = 10000, 
                          meanlog = x,
                          sdlog = y)
              
              res <- res * 2183.475
              
              return(sum(res < 155)/10000)
            })

plan(sequential)

pct_below_radar_threshold_male %>% 
  unlist() %>% 
  median() #0.2817

pct_below_radar_threshold_male %>% 
  unlist() %>% 
  hdi(ci = 0.5) #50% HDI: [0.21, 0.33]

pct_below_radar_threshold_male %>% 
  unlist() %>% 
  hdi(ci = 0.95) #95% HDI: [0.12, 0.46]

#female
plan(multisession)

pct_below_radar_threshold_female <- future_map2(.x = rstan::extract(sex_results, "mu_alt_female")[[1]], 
            .y = rstan::extract(sex_results, "sigma_alt_female")[[1]],
            .progress = TRUE,
            .options = furrr_options(seed = 8),
            .f = function(x, y){
              res <- rlnorm(n = 10000, 
                          meanlog = x,
                          sdlog = y)
              
              res <- res * 2183.475
              
              return(sum(res < 155)/10000)
            })

plan(sequential)

pct_below_radar_threshold_female %>% 
  unlist() %>% 
  median() #0.3598

pct_below_radar_threshold_female %>% 
  unlist() %>% 
  hdi(ci = 0.5) #50% HDI: [0.28, 0.42]

pct_below_radar_threshold_female %>% 
  unlist() %>% 
  hdi(ci = 0.95) #95% HDI: [0.17, 0.56]
```

How may of these locations are at an altitude where they might collide with a building (0-47m)?
```{r}
#male
plan(multisession)

pct_below_building_threshold_male <- future_map2(.x = rstan::extract(sex_results, "mu_alt_male")[[1]], 
            .y = rstan::extract(sex_results, "sigma_alt_male")[[1]],
            .progress = TRUE,
            .options = furrr_options(seed = 8),
            .f = function(x, y){
              res <- rlnorm(n = 10000, 
                          meanlog = x,
                          sdlog = y)
              
              res <- res * 2183.475
              
              derived <- sum(res <= 47)/10000
              
              return(derived)
            })

plan(sequential)

pct_below_building_threshold_male %>% 
  unlist() %>% 
  median() #0.031

pct_below_building_threshold_male %>% 
  unlist() %>% 
  hdi(ci = 0.5) #50% HDI: [0.00, 0.03]

pct_below_building_threshold_male %>% 
  unlist() %>% 
  hdi(ci = 0.95) #95% HDI: [0.00, 0.12]

#female
plan(multisession)

pct_below_building_threshold_female <- future_map2(.x = rstan::extract(sex_results, "mu_alt_female")[[1]], 
            .y = rstan::extract(sex_results, "sigma_alt_female")[[1]],
            .progress = TRUE,
            .options = furrr_options(seed = 8),
            .f = function(x, y){
              res <- rlnorm(n = 10000, 
                          meanlog = x,
                          sdlog = y)
              
              res <- res * 2183.475
              
              derived <- sum(res <= 47)/10000
              
              return(derived)
            })

plan(sequential)

pct_below_building_threshold_female %>% 
  unlist() %>% 
  median() #0.0523

pct_below_building_threshold_female %>% 
  unlist() %>% 
  hdi(ci = 0.5) #50% HDI: [0.00, 0.06]

pct_below_building_threshold_female %>% 
  unlist() %>% 
  hdi(ci = 0.95) #95% HDI: [0.00, 0.18]
```

How may of these locations are at an altitude where they might collide with a comm tower (0-305m)?
```{r}
#male
plan(multisession)

pct_below_comm_tower_threshold_male <- future_map2(.x = rstan::extract(sex_results, "mu_alt_male")[[1]], 
            .y = rstan::extract(sex_results, "sigma_alt_male")[[1]],
            .progress = TRUE,
            .options = furrr_options(seed = 8),
            .f = function(x, y){
              res <- rlnorm(n = 10000, 
                          meanlog = x,
                          sdlog = y)
              
              res <- res * 2183.475
              
              derived <- sum(res <= 305)/10000
              
              return(derived)
            })

plan(sequential)

pct_below_comm_tower_threshold_male %>% 
  unlist() %>% 
  median() #0.5608

pct_below_comm_tower_threshold_male %>% 
  unlist() %>% 
  hdi(ci = 0.5) #50% HDI: [0.51, 0.61]

pct_below_comm_tower_threshold_male %>% 
  unlist() %>% 
  hdi(ci = 0.95) #95% HDI: [0.41, 0.70]

#female
plan(multisession)

pct_below_comm_tower_threshold_female <- future_map2(.x = rstan::extract(sex_results, "mu_alt_female")[[1]], 
            .y = rstan::extract(sex_results, "sigma_alt_female")[[1]],
            .progress = TRUE,
            .options = furrr_options(seed = 8),
            .f = function(x, y){
              res <- rlnorm(n = 10000, 
                          meanlog = x,
                          sdlog = y)
              
              res <- res * 2183.475
              
              derived <- sum(res <= 305)/10000
              
              return(derived)
            })

plan(sequential)

pct_below_comm_tower_threshold_female %>% 
  unlist() %>% 
  median() #0.6415

pct_below_comm_tower_threshold_female %>% 
  unlist() %>% 
  hdi(ci = 0.5) #50% HDI: [0.60, 0.70]

pct_below_comm_tower_threshold_female %>% 
  unlist() %>% 
  hdi(ci = 0.95) #95% HDI: [0.49, 0.78]
```

How may of these locations are at an altitude where they might collide with a wind turbine (32.2-163.8m)?
```{r}
#male
plan(multisession)

pct_below_wind_threshold_male <- future_map2(.x = rstan::extract(sex_results, "mu_alt_male")[[1]], 
            .y = rstan::extract(sex_results, "sigma_alt_male")[[1]],
            .progress = TRUE,
            .options = furrr_options(seed = 8),
            .f = function(x, y){
              res <- rlnorm(n = 10000, 
                          meanlog = x,
                          sdlog = y)
              
              res <- res * 2183.475
              
              derived <- sum(res > 32.2 & res <= 163.8)/10000
              
              return(derived)
            })

plan(sequential)

pct_below_wind_threshold_male %>% 
  unlist() %>% 
  median() #0.2892

pct_below_wind_threshold_male %>% 
  unlist() %>% 
  hdi(ci = 0.5) #50% HDI: [0.24, 0.34]

pct_below_wind_threshold_male %>% 
  unlist() %>% 
  hdi(ci = 0.95) #95% HDI: [0.15, 0.42]

#female
plan(multisession)

pct_below_wind_threshold_female <- future_map2(.x = rstan::extract(sex_results, "mu_alt_female")[[1]], 
            .y = rstan::extract(sex_results, "sigma_alt_female")[[1]],
            .progress = TRUE,
            .options = furrr_options(seed = 8),
            .f = function(x, y){
              res <- rlnorm(n = 10000, 
                          meanlog = x,
                          sdlog = y)
              
              res <- res * 2183.475
              
              derived <- sum(res > 32.2 & res <= 163.8)/10000
              
              return(derived)
            })

plan(sequential)

pct_below_wind_threshold_female %>% 
  unlist() %>% 
  median() #0.358

pct_below_wind_threshold_female %>% 
  unlist() %>% 
  hdi(ci = 0.5) #50% HDI: [0.33, 0.43]

pct_below_wind_threshold_female %>% 
  unlist() %>% 
  hdi(ci = 0.95) #95% HDI: [0.20, 0.48]
```

Quantify the likelihood that one sex's mean is greater than the other
This is called probability of superiority: see "A Probability-Based Measure of Effect Size: Robustness to Base Rates and Other Factors"
```{r}
sum(unlist(mean_draws_male) > unlist(mean_draws_female))*100/length(unlist(mean_draws_male))
#79.43333 probability that the female mean is higher than the male mean
```

